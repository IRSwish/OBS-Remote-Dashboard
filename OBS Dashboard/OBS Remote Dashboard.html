<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>OBS Remote Console + Mixer</title>
<style>
:root {
  --bg:#0f1720;
  --panel:#0b1220;
  --muted:#9aa4b2;
  --accent:#00c9ff;
  --accent2:#f52584;
  --glass: rgba(255,255,255,0.05);
  --card-radius:10px;
  --gap:12px;
  font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:linear-gradient(180deg,var(--bg),#07101a);color:#e6eef6;height:100vh;display:flex;flex-direction:column}

/* TOPBAR */
.topbar {display:flex; align-items:center; gap:12px; padding:10px 16px; background:var(--glass); border-radius:0 0 12px 12px;}
.brand {font-weight:600;display:flex;align-items:center;gap:8px;}
.brand .logo {width:32px;height:32px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700}
.ws-config{display:flex;gap:6px;align-items:center;margin-left:20px;}
.ws-config input{padding:4px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:#fff;width:110px}
.ws-config button{padding:4px 10px;border-radius:6px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#07101a;cursor:pointer}
.status{margin-left:auto;display:flex;gap:12px;align-items:center}
.status .pill{background:rgba(255,255,255,0.08);padding:6px 10px;border-radius:999px;font-size:13px;min-width:70px;text-align:center}

/* MAIN GRID */
.main {flex:1; display:grid; grid-template-columns:260px 1fr 360px; gap:var(--gap); padding:var(--gap);}

/* Panels */
.panel {background:var(--panel); border-radius:var(--card-radius); padding:12px; display:flex; flex-direction:column;}

/* Scenes */
#sceneList {display:flex; flex-direction:column; gap:6px; flex:1;}
.scene {padding:6px; border-radius:6px; border:none; background:#284cb8; color:#fff; cursor:pointer; text-align:left; user-select:none; transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease; overflow:hidden; max-height:50px; opacity:1; margin:2px 0;}
.scene.hidden { max-height:0; opacity:0; margin:0; }
.scene:hover{ background:#3c54d1; }
.scene.preview { background:#00c9ff; }
.scene.program { background:#f52584; }

.separator {padding:4px; margin:4px 0; background:#222; color:#f52584; font-weight:bold; display:flex; align-items:center; gap:6px; border:1px dashed #555; border-radius:4px; cursor:pointer; user-select:none;}
.separator.expanded::before { content:"▼"; }
.separator:not(.expanded)::before { content:"▶"; }
.separator .deleteBtn {margin-left:auto; color:#fff; background:#f52584; border:none; border-radius:4px; cursor:pointer; padding:0 4px; font-weight:bold;}
.separator .deleteBtn:hover { background:#ff5a8f; }
#addSeparatorBtn {margin-top:8px; padding:6px; border:none; border-radius:6px; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#07101a; cursor:pointer; font-weight:bold;}

/* Preview / Program */
#previewPanel img, #programImg {width:100%; height:auto; border-radius:6px; background:#000; display:block;}

/* Mixer */
#mixer {display:flex; gap:12px; align-items:flex-end; height:280px; overflow-x:auto; padding-bottom:12px;}
.channel {display:flex; flex-direction:column; align-items:center;}
.fader {width:40px; height:200px; background:rgba(255,255,255,0.05); border-radius:6px; position:relative;writing-mode: vertical-RL;direction: rtl;}
.level {width:100%; background:linear-gradient(to top,var(--accent2),var(--accent)); height:0%; transition:height 0.1s linear; position:absolute; bottom:0; left:0; border-radius:6px;}
.slider {width:100%; height:100%; opacity:0;}
.name {margin-top:6px; font-size:12px; text-align:center; word-break:break-word; max-width:60px;}
.dblabel {font-size:12px; text-align:center; margin-bottom:4px;}
button.muteBtn {margin-top:4px;font-size:10px;padding:2px 6px;border-radius:4px;border:none;cursor:pointer;background:#555;color:#fff;}

/* Chat */
.chat-header{display:flex;gap:6px;margin-bottom:6px;}
.chat-header input{flex:1;padding:4px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:#fff;}
.chat-header button{padding:4px 6px;border-radius:6px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#07101a;cursor:pointer;}
.chat-iframe{width:100%;flex:1;border:none;border-radius:6px;background:#000;}

/* Mixer panel bottom align */
#previewPanel { display:flex; flex:1;flex-direction: column; gap: 12px;}
#mixerPanel {margin-top:auto;}
</style>
</head>
<body>
<div class="topbar">
  <div class="brand"><div class="logo">O</div>OBS Remote</div>
  <div class="ws-config">
    <input type="text" id="obsIP" placeholder="IP:Port" value="localhost:4455"/>
    <input type="password" id="obsPass" placeholder="Password"/>
    <button id="connectBtn">Connect</button>
  </div>
  <div class="status">
    <div class="pill" id="liveStatus">OFFLINE</div>
    <div class="pill" id="programScene">PRG: -</div>
    <div class="pill" id="cpuFps">CPU 0% • FPS 0</div>
  </div>
</div>

<div class="main">
  <!-- Scenes Panel -->
  <div class="panel" id="scenesPanel">
    <h3>Scenes</h3>
    <div id="sceneList"></div>
    <button id="addSeparatorBtn">+ Séparateur</button>
  </div>

  <!-- Center: Preview + Mixer -->
  <div style="display:flex; flex-direction:column; gap:12px;">
    <div class="panel" id="previewPanel">
      <h3>Preview / Program</h3>
      <img id="previewImg" src="" />
      <img id="programImg" src="" style="margin-top:6px;" />
    </div>

    <div class="panel" id="mixerPanel">
      <h3>Mixer</h3>
      <div id="mixer"></div>
    </div>
  </div>

  <!-- Chat Panel -->
  <div class="panel" style="display:flex; flex-direction:column;">
    <h3>Chat</h3>
    <div class="chat-header">
      <input type="text" id="chatChannel" placeholder="Twitch channel" value="pseudo"/>
      <button id="loadChat">Load Chat</button>
    </div>
    <iframe id="chatFrame" class="chat-iframe" src="https://www.twitch.tv/popout/pseudo/chat"></iframe>
  </div>
</div>

<script>
let ws;
const channels = {};
const sceneList = document.getElementById("sceneList");

// OBS connection
document.getElementById("connectBtn").addEventListener("click", ()=>{
  const ip = document.getElementById("obsIP").value.trim();
  const pass = document.getElementById("obsPass").value.trim();
  connectOBS(ip, pass);
});

function connectOBS(ip, pass){
  if(ws) ws.close();
  ws = new WebSocket("ws://"+ip);

  ws.onopen = ()=> ws.send(JSON.stringify({op:1,d:{rpcVersion:1,authentication:pass}}));

  ws.onmessage = e=>{
    const msg = JSON.parse(e.data);

    if(msg.op===2){
      document.getElementById("liveStatus").textContent = "CONNECTED";
      sendRequest("GetSceneList","scenes");
      sendRequest("GetInputList","inputs");
    }

    // Scenes list
    if(msg.op===7 && msg.d.requestId==="scenes" && msg.d.responseData?.scenes){
      createScenes(msg.d.responseData.scenes);
    }

    // Mixer
    if(msg.op===7 && msg.d.requestId==="inputs" && msg.d.responseData?.inputs){
      createMixer(msg.d.responseData.inputs);
    }

    // Volume change
    if(msg.op===5 && msg.d.eventType==="InputVolumeChanged"){
      const ev = msg.d.eventData; if(!ev) return;
      const name = ev.inputName || ev.inputId;
      const levelValue = typeof ev.inputVolumeMul==="number" ? ev.inputVolumeMul : 0;
      if(channels[name] && !channels[name].isSliding){
        channels[name].level.style.height = (levelValue*100)+"%";
        channels[name].dblabel.textContent = (20*Math.log10(Math.max(levelValue,0.0001))).toFixed(1)+" dB";
      }
    }

    // Mute change
    if(msg.op===5 && msg.d.eventType==="InputMuteStateChanged"){
      const ev = msg.d.eventData; if(!ev) return;
      const name = ev.inputName || ev.inputId;
      const muted = !!ev.inputMuted;
      if(channels[name] && channels[name].muteBtn){
        channels[name].muteBtn.style.background = muted ? "#f52584" : "#555";
        channels[name].muteBtn.textContent = muted ? "Muted" : "Mute";
        channels[name].muteBtn.isMuted = muted;
      }
    }

    // Logging initial volume/mute
    if(msg.op===7 && msg.d.responseData){
      const id = msg.d.requestId;
      const resp = msg.d.responseData;
      if(id.startsWith("log_vol_")){
        const chName = id.replace("log_vol_","");
        if(channels[chName]){
          const vol = resp.inputVolumeMul ?? 0;
          channels[chName].level.style.height = (vol*100)+"%";
          channels[chName].slider.value = Math.round(vol*100);
          channels[chName].dblabel.textContent = (20*Math.log10(Math.max(vol,0.0001))).toFixed(1)+" dB";
        }
      }
      if(id.startsWith("log_mute_")){
        const chName = id.replace("log_mute_","");
        const muted = !!resp.inputMuted;
        if(channels[chName]){
          channels[chName].muteBtn.style.background = muted ? "#f52584" : "#555";
          channels[chName].muteBtn.textContent = muted ? "Muted" : "Mute";
          channels[chName].muteBtn.isMuted = muted;
        }
      }
    }
  };

  ws.onclose = ()=> document.getElementById("liveStatus").textContent = "OFFLINE";
}

function sendRequest(type,id,data={}) {
  if(!ws || ws.readyState!==1) return;
  ws.send(JSON.stringify({op:6,d:{requestType:type,requestId:id,requestData:data}}));
}

// ---------------------
// SCENES + Separators
// ---------------------
function createScenes(scenes){
  sceneList.innerHTML="";
  const saved = JSON.parse(localStorage.getItem("sceneOrder")||"[]");

  if(saved.length){
    saved.forEach(item=>{
      if(item.type==="separator") addSeparator(item.name,item.expanded);
      else addScene(item.name);
    });
    // Ajuste l'affichage selon l'état des séparateurs
    Array.from(sceneList.children).forEach(el=>{
      if(el.classList.contains("separator")){
        let next = el.nextElementSibling;
        while(next && !next.classList.contains("separator")){
          next.style.display = el.classList.contains("expanded") ? "block" : "none";
          next = next.nextElementSibling;
        }
      }
    });
  } else {
    scenes.forEach(s=>addScene(s.sceneName));
  }
}

function addScene(name){
  const btn = document.createElement("button");
  btn.className="scene";
  btn.textContent=name;
  sceneList.appendChild(btn);

  let clickTimeout;
  btn.addEventListener("click", ()=>{
    if(clickTimeout) return;
    clickTimeout = setTimeout(()=>{
      clickTimeout=null;
      if(ws && ws.readyState===1){
        sendRequest("SetCurrentPreviewScene","prev_"+name,{sceneName:name});
      }
      document.querySelectorAll(".scene").forEach(s=>s.classList.remove("preview"));
      btn.classList.add("preview");
    },250);
  });

  btn.addEventListener("dblclick", ()=>{
    if(clickTimeout){ clearTimeout(clickTimeout); clickTimeout=null; }
    if(ws && ws.readyState===1){
      sendRequest("SetCurrentProgramScene","prog_"+name,{sceneName:name});
    }
    document.querySelectorAll(".scene").forEach(s=>s.classList.remove("program","preview"));
    btn.classList.add("program");
    document.getElementById("programScene").textContent = "PRG: " + name;
  });

  addDragEvents(btn);
}

function addSeparator(name,expanded=true){
  const div = document.createElement("div");
  div.className="separator";
  if(expanded) div.classList.add("expanded");
  div.innerHTML=`<span class="title">${name}</span><button class="deleteBtn">×</button>`;
  sceneList.appendChild(div);

  // Toggle expand/collapse
  div.addEventListener("click", e=>{
    if(e.target.classList.contains("deleteBtn")) return;
    div.classList.toggle("expanded");
    let next = div.nextElementSibling;
    while(next && !next.classList.contains("separator")){
      next.style.display = div.classList.contains("expanded") ? "block" : "none";
      next = next.nextElementSibling;
    }
    saveSceneOrder();
  });

  // Rename
  div.querySelector(".title").addEventListener("click", e=>{
    e.stopPropagation();
    const newName = prompt("Renommer le séparateur :", div.querySelector(".title").textContent);
    if(newName) div.querySelector(".title").textContent = newName;
    saveSceneOrder();
  });

  // Delete
  div.querySelector(".deleteBtn").addEventListener("click", e=>{
    e.stopPropagation();
    div.remove();
    saveSceneOrder();
  });

  addDragEvents(div);
}

document.getElementById("addSeparatorBtn").addEventListener("click", ()=>addSeparator("Nouveau séparateur"));

function addDragEvents(el){
  el.draggable = true;
  el.addEventListener("dragstart", e=>{
    e.dataTransfer.setData("text/plain", Array.from(sceneList.children).indexOf(el));
  });
  el.addEventListener("dragover", e=> e.preventDefault());
  el.addEventListener("drop", e=>{
    e.preventDefault();
    const fromIndex = parseInt(e.dataTransfer.getData("text/plain"));
    const toIndex = Array.from(sceneList.children).indexOf(el);
    if(fromIndex===toIndex) return;
    const node = sceneList.children[fromIndex];
    if(fromIndex < toIndex) sceneList.insertBefore(node, sceneList.children[toIndex].nextSibling);
    else sceneList.insertBefore(node, sceneList.children[toIndex]);
    saveSceneOrder();
  });
}

function saveSceneOrder(){
  const arr = [];
  Array.from(sceneList.children).forEach(c=>{
    if(c.classList.contains("separator")){
      arr.push({type:"separator",name:c.querySelector(".title").textContent,expanded:c.classList.contains("expanded")});
    } else {
      arr.push({type:"scene",name:c.textContent});
    }
  });
  localStorage.setItem("sceneOrder",JSON.stringify(arr));
}

// ---------------------
// MIXER
// ---------------------
function createMixer(inputs){
  const mixer = document.getElementById("mixer");
  mixer.innerHTML="";
  Object.keys(channels).forEach(k=>delete channels[k]);

  inputs.forEach(input=>{
    if(!input.inputKind.startsWith("audio") && !input.inputKind.includes("wasapi") && !input.inputKind.includes("vlc")) return;
    const name = input.inputName || input.inputId;

    const channel = document.createElement("div");
    channel.className="channel";

    const dblabel = document.createElement("div");
    dblabel.className="dblabel"; dblabel.textContent="-∞ dB";
    channel.appendChild(dblabel);

    const fader = document.createElement("div"); fader.className="fader";
    const level = document.createElement("div"); level.className="level"; level.style.height="0%";
    fader.appendChild(level);

    const slider = document.createElement("input"); slider.type="range"; slider.min=0; slider.max=100; slider.value=0; slider.className="slider";

    let isSliding=false;
    slider.addEventListener("mousedown", ()=>isSliding=true);
    slider.addEventListener("mouseup", ()=>isSliding=false);
    slider.addEventListener("touchstart", ()=>isSliding=true);
    slider.addEventListener("touchend", ()=>isSliding=false);

    slider.addEventListener("input", ()=>{
      const sliderVal = slider.value/100;
      const vol = sliderVal*sliderVal;
      level.style.height=(sliderVal*100)+"%";
      dblabel.textContent=(20*Math.log10(Math.max(vol,0.0001))).toFixed(1)+" dB";
      if(ws && ws.readyState===1) sendRequest("SetInputVolume","set_"+name,{inputName:name,inputVolumeMul:vol});
    });

    fader.appendChild(slider); channel.appendChild(fader);

    const muteBtn = document.createElement("button"); muteBtn.className="muteBtn"; muteBtn.textContent="Mute"; muteBtn.style.background="#555";
    let isMuted=false;
    muteBtn.addEventListener("click", ()=>{
      isMuted=!isMuted;
      muteBtn.style.background=isMuted?"#f52584":"#555";
      muteBtn.textContent=isMuted?"Muted":"Mute";
      if(ws && ws.readyState===1) sendRequest("SetInputMute","mute_"+name,{inputName:name,inputMuted:isMuted});
    });
    channel.appendChild(muteBtn);

    const nameDiv=document.createElement("div"); nameDiv.className="name"; nameDiv.textContent=name; channel.appendChild(nameDiv);

    mixer.appendChild(channel);
    channels[name]={level,slider,dblabel,muteBtn,get isSliding(){return isSliding;}};

    ws.send(JSON.stringify({op:6,d:{requestType:"SubscribeToInputVolumeChanged",requestId:"sub_"+name,requestData:{inputName:name}}}));
    ws.send(JSON.stringify({op:6,d:{requestType:"Subscribe",requestId:"sub_mute_"+name,requestData:{events:["InputMuteStateChanged"]}}}));

    setTimeout(()=>{ sendRequest("GetInputVolume","log_vol_"+name,{inputName:name}); sendRequest("GetInputMute","log_mute_"+name,{inputName:name}); },50);
  });
}

// ---------------------
// Chat
// ---------------------
document.getElementById("loadChat").addEventListener("click",()=>{
  const ch = document.getElementById("chatChannel").value.trim();
  if(ch) document.getElementById("chatFrame").src=`https://www.twitch.tv/popout/${ch}/chat`;
});

// ---------------------
// Mock CPU/FPS
// ---------------------
setInterval(()=>{
  const cpu=Math.floor(Math.random()*50);
  const fps=Math.floor(24+Math.random()*6);
  document.getElementById("cpuFps").textContent=`CPU ${cpu}% • FPS ${fps}`;
},1000);
</script>
</body>
</html>
